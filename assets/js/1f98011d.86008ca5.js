"use strict";(self.webpackChunkcatenax_ng=self.webpackChunkcatenax_ng||[]).push([[4580],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return u}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(a),u=r,h=d["".concat(s,".").concat(u)]||d[u]||m[u]||o;return a?n.createElement(h,i(i({ref:t},c),{},{components:a})):n.createElement(h,i({ref:t},c))}));function u(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},2242:function(e,t,a){a.r(t),a.d(t,{assets:function(){return c},contentTitle:function(){return s},default:function(){return u},frontMatter:function(){return l},metadata:function(){return p},toc:function(){return m}});var n=a(7462),r=a(3366),o=(a(7294),a(3905)),i=["components"],l={title:"How To Onboard Product-Teams To Any Environment",slug:"/how-to-onboard-teams-to-any-environment"},s=void 0,p={unversionedId:"internal/how-to-onboard-teams-to-any-environment",id:"internal/how-to-onboard-teams-to-any-environment",title:"How To Onboard Product-Teams To Any Environment",description:"This guide is only for those who operate the environment",source:"@site/docs/internal/how-to-onboard-teams-to-any-environment.md",sourceDirName:"internal",slug:"/how-to-onboard-teams-to-any-environment",permalink:"/docs/how-to-onboard-teams-to-any-environment",draft:!1,editUrl:"https://github.com/catenax-ng/catenax-ng.github.io/edit/main/docs/internal/how-to-onboard-teams-to-any-environment.md",tags:[],version:"current",frontMatter:{title:"How To Onboard Product-Teams To Any Environment",slug:"/how-to-onboard-teams-to-any-environment"},sidebar:"tutorialSidebar",previous:{title:"Internal Guides",permalink:"/docs/internal"},next:{title:"How to onboard teams to sonarcloud",permalink:"/docs/how-to-onboard-teams-to-sonarcloud"}},c={},m=[{value:"Create A Jira Task",id:"create-a-jira-task",level:2},{value:"Team Onboarding",id:"team-onboarding",level:3},{value:"Member Onboarding",id:"member-onboarding",level:3},{value:"GitHub - Prerequisites",id:"github---prerequisites",level:2},{value:"Invite Someone To The GitHub Organization",id:"invite-someone-to-the-github-organization",level:3},{value:"GitHub Team",id:"github-team",level:3},{value:"Add a Member To A GitHub Team",id:"add-a-member-to-a-github-team",level:3},{value:"Vault",id:"vault",level:2},{value:"Initialize terraform",id:"initialize-terraform",level:3},{value:"Add the new team to the list of product teams",id:"add-the-new-team-to-the-list-of-product-teams",level:3},{value:"Create and apply the terraform plan",id:"create-and-apply-the-terraform-plan",level:3},{value:"ArgoCD",id:"argocd",level:2},{value:"Create ArgoCD Project",id:"create-argocd-project",level:3},{value:"Create AVP Secret",id:"create-avp-secret",level:3},{value:"Prepare Deployment Of ArgoCD Project And AVP Secret",id:"prepare-deployment-of-argocd-project-and-avp-secret",level:3},{value:"Create Pull Request",id:"create-pull-request",level:3},{value:"Special Topics",id:"special-topics",level:2},{value:"Enable access to a private repository via deploy key",id:"enable-access-to-a-private-repository-via-deploy-key",level:3},{value:"Enable access to a private package (central pull secret)",id:"enable-access-to-a-private-package-central-pull-secret",level:3}],d={toc:m};function u(e){var t=e.components,l=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,n.Z)({},d,l,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"This guide is only for those who operate the environment"))),(0,o.kt)("h2",{id:"create-a-jira-task"},"Create A Jira Task"),(0,o.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"This chapter needs to be rewritten/redefined due to unclear statements in former version of this document!"))),(0,o.kt)("h3",{id:"team-onboarding"},"Team Onboarding"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"who wants which access"),(0,o.kt)("li",{parentName:"ol"},"use \u2018labels\u2019 for differentiate tasks e.g. 'onboarding', 'maintainer switched'"),(0,o.kt)("li",{parentName:"ol"},"add to current sprint")),(0,o.kt)("h3",{id:"member-onboarding"},"Member Onboarding"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"who wants which access"),(0,o.kt)("li",{parentName:"ol"},"use \u2018labels\u2019 for differentiate tasks e.g. 'onboarding', 'maintainer switched'"),(0,o.kt)("li",{parentName:"ol"},"add to current sprint")),(0,o.kt)("h2",{id:"github---prerequisites"},"GitHub - Prerequisites"),(0,o.kt)("h3",{id:"invite-someone-to-the-github-organization"},"Invite Someone To The GitHub Organization"),(0,o.kt)("p",null,"Prerequisites:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"GitHub username, full name or email address of person to onboard"),(0,o.kt)("li",{parentName:"ul"},"GitHub team name to invite someone to (the team must have been created by DevSecOps team)")),(0,o.kt)("p",null,"To invite a person to a specific GitHub team, follow these steps:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"In GitHub organization go to ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/orgs/catenax-ng/people"},"People")),(0,o.kt)("li",{parentName:"ul"},"Click button ",(0,o.kt)("em",{parentName:"li"},"Invite member")," on the right side"),(0,o.kt)("li",{parentName:"ul"},"In the field ",(0,o.kt)("em",{parentName:"li"},"Search by username, full name or email address")," enter one of the suggestions and select user"),(0,o.kt)("li",{parentName:"ul"},"Click on ",(0,o.kt)("em",{parentName:"li"},"Invite")," to finally invite someone to CatenaX-NG GitHub organization")),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"The person must click/accept the invitation to our GitHub organization before someone can be added to one of our\norganization teams."))),(0,o.kt)("h3",{id:"github-team"},"GitHub Team"),(0,o.kt)("p",null,"If a team requests for initial onboarding to CatenaX-NG GitHub organization, follow these steps to create a team inside\nGitHub organization:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"In GitHub organization go to ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/orgs/catenax-ng/teams"},"Teams")," and click button ",(0,o.kt)("em",{parentName:"li"},"New team")," in the\nright upper corner"),(0,o.kt)("li",{parentName:"ul"},"Insert ",(0,o.kt)("em",{parentName:"li"},"Team name")," with naming schema ",(0,o.kt)("inlineCode",{parentName:"li"},"product-<productName>")),(0,o.kt)("li",{parentName:"ul"},"Add optional ",(0,o.kt)("em",{parentName:"li"},"Description")),(0,o.kt)("li",{parentName:"ul"},"Apply defaults for ",(0,o.kt)("em",{parentName:"li"},"Parent team")," and ",(0,o.kt)("em",{parentName:"li"},"Team visibility")),(0,o.kt)("li",{parentName:"ul"},"Click button ",(0,o.kt)("em",{parentName:"li"},"Create team")," to finally create the team")),(0,o.kt)("h3",{id:"add-a-member-to-a-github-team"},"Add a Member To A GitHub Team"),(0,o.kt)("p",null,"Prerequisites:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Person must have accepted the invitation to the GitHub organization"),(0,o.kt)("li",{parentName:"ul"},"GitHub username of whom to onboard (person must have been invited ",(0,o.kt)("em",{parentName:"li"},"and")," joined our GitHub organization)"),(0,o.kt)("li",{parentName:"ul"},"GitHub team to invite to (the team must have been created by DevSecOps team)")),(0,o.kt)("p",null,"To add a member to a GitHub team, follow these steps:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"In GitHub organization go to ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/orgs/catenax-ng/teams"},"Teams")),(0,o.kt)("li",{parentName:"ul"},"Click on the team name a member should be added to"),(0,o.kt)("li",{parentName:"ul"},"Click on ",(0,o.kt)("em",{parentName:"li"},"Members")," in the top menu inside the selected GitHub team"),(0,o.kt)("li",{parentName:"ul"},"Click on the green button ",(0,o.kt)("em",{parentName:"li"},"Add a member")," in the upper right"),(0,o.kt)("li",{parentName:"ul"},"Type the GitHub ",(0,o.kt)("em",{parentName:"li"},"username, full name, or email addess")," and click ",(0,o.kt)("em",{parentName:"li"},"Invite"))),(0,o.kt)("p",null,"After the member has been added to the GitHub team, check the checkbox in front of the new member and change role to ",(0,o.kt)("em",{parentName:"p"},"\nMaintainer"),":"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"GH Role Maintainer",src:a(6584).Z,width:"725",height:"384"})),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"If the person gets no email: the person should check the GitHub notifications-box or/and email spam folder."))),(0,o.kt)("h2",{id:"vault"},"Vault"),(0,o.kt)("p",null,"To be able to manage secrets in Hashicorp Vault and use them via ArgoCD Vault Plugin (AVP), a team needs the following\nVault resources set up:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"A ",(0,o.kt)("em",{parentName:"li"},"secret engine")),(0,o.kt)("li",{parentName:"ul"},"A ",(0,o.kt)("em",{parentName:"li"},"read-write policy")," for the secret engine, used to manage secrets via web UI or CLI; Mapped to the GitHub team"),(0,o.kt)("li",{parentName:"ul"},"An ",(0,o.kt)("em",{parentName:"li"},"approle"),", that is used as AVP credentials"),(0,o.kt)("li",{parentName:"ul"},"A ",(0,o.kt)("em",{parentName:"li"},"read-only policy")," for the secret engine, used as AVP credentials; Mapped to the approle"),(0,o.kt)("li",{parentName:"ul"},"Approle credentials (secret-id and role-id) available as ",(0,o.kt)("em",{parentName:"li"},"avp-config in the devsecops")," secret engine")),(0,o.kt)("p",null,"All of these resources are created through terraform scripts. The scripts are part of the\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/catenax-ng/k8s-cluster-stack"},"k8s_cluster_stack")," repository. The following sections will guide you\nthrough the process of initializing terraform, adding the new team to the list of product teams, creating the terraform\nplan and applying the plan to vault."),(0,o.kt)("h3",{id:"initialize-terraform"},"Initialize terraform"),(0,o.kt)("p",null,"It is assumed, that you already have installed the terraform CLI. Before you start, make sure you've cloned\nthe ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/catenax-ng/k8s-cluster-stack"},"k8s_cluster_stack"),"\nrepository and navigated to ",(0,o.kt)("inlineCode",{parentName:"p"},"/terraform/02_vault")," inside that repository on your terminal."),(0,o.kt)("p",null,"To run the terraform scripts later on, you need to set two specific environment variables. One is used to access the\nAzure storage account, that contains the tfstate file and one with a Vault token for authentication on Vault. You can\nset these like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"# Requires you to be logged in with az on the cli\nexport ARM_ACCESS_KEY=$(az storage account keys list --resource-group cx-devsecops-tfstates --account-name cxdevsecopstfstate --query '[0].value' -o tsv)\n\n# You can get a login token, by logging into the Vault web UI and using 'copy token' from the top right user menu\nexport VAULT_TOKEN=<your-vault-token-or-root-token>\n")),(0,o.kt)("p",null,"Before creating a terraform plan, you need to initialize terraform, which will download all the provider plugins needed\nto run the scripts. Therefore, run ",(0,o.kt)("inlineCode",{parentName:"p"},"terraform init"),"."),(0,o.kt)("h3",{id:"add-the-new-team-to-the-list-of-product-teams"},"Add the new team to the list of product teams"),(0,o.kt)("p",null,"After initializing terraform and preparing the necessary environment variables as described before, you can adjust the\nterraform scripts to onboard the new team. All the product teams are listed in a variable named 'product_teams', that is\nused in a 'for_each' loop in the resource definitions."),(0,o.kt)("p",null,"So all you need to do to create all the resources necessary for the team, is to add it to that 'product_teams' map.\nTherefore, open the variables file at ",(0,o.kt)("inlineCode",{parentName:"p"},"/terraform/02_vault/variables.tf")," and append a new map entry to the default value\nof the variable definition. All the properties, that are defined in the variable definition are mandatory to be\nspecified in the map entry, since all of them are used inside the resource definitions."),(0,o.kt)("h3",{id:"create-and-apply-the-terraform-plan"},"Create and apply the terraform plan"),(0,o.kt)("p",null,"Since terraform is not only creating Vault resources for product teams, but also configures OIDC login, you need to\nspecify required settings, that are not checked into version control, since this is sensitive information."),(0,o.kt)("p",null,"The OIDC settings that needs to be specified is the client-id and the client-secret for DEX. You can find this\ninformation in our devsecops secret engine in vault at path ",(0,o.kt)("inlineCode",{parentName:"p"},"devsecops/clusters/vault/github-oauth"),"."),(0,o.kt)("p",null,"To set this information, you can either copy and paste it, when terraform asks you for it on plan creation, or you\ncould specify it beforehand as environment variable like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"export TF_VAR_vault_oidc_client_id=<client-id-copied-from-vault>\nexport TF_VAR_vault_oidc_client_secret=<client-secret-copied-from-vault>\n")),(0,o.kt)("p",null,"Now you can create a terraform plan with this command: ",(0,o.kt)("inlineCode",{parentName:"p"},"terraform plan -out tf.plan"),"\nTerraform will print a summary, of what changes it will do to Vault, once you apply the generated plan.\nCheck the summary carefully, that it actually matches your expectations. In our case of onboarding a new team,\nthere should only be new resources getting created and no changes or destruction of existing ones.\nIf there are actually changes or destruction listed in the plan summary, double check, if you are at the HEAD revision,\nor you accidentally changed some resource definitions."),(0,o.kt)("p",null,"If the plan summary matches your expectations, then you can apply the changes with this command:\n",(0,o.kt)("inlineCode",{parentName:"p"},'terraform apply "tf.plan"'),"\nAfterwards, you can manually check Vault, if all the resources actually got created."),(0,o.kt)("h2",{id:"argocd"},"ArgoCD"),(0,o.kt)("p",null,"To provide a product-team access to the Hotel Budapest infrastructure following onboarding steps must be performed (all\nsteps are related to repository ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/catenax-ng/k8s-cluster-stack"},"k8s_cluster_stack"),"):"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"create ArgoCD project"),(0,o.kt)("li",{parentName:"ul"},"create AVP secret"),(0,o.kt)("li",{parentName:"ul"},"deploy ArgoCD project and AVP secret")),(0,o.kt)("p",null,"Create a new branch in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/catenax-ng/k8s-cluster-stack"},"k8s_cluster_stack")," repo for onboarding a new\nproduct-team to ArgoCD."),(0,o.kt)("h3",{id:"create-argocd-project"},"Create ArgoCD Project"),(0,o.kt)("p",null,"Create a manifest for the new product-team to create:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"k8s namespace"),(0,o.kt)("li",{parentName:"ul"},"ArgoCD project:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Namespace\nmetadata:\n  name: product-productName\n---\napiVersion: argoproj.io/v1alpha1\nkind: AppProject\nmetadata:\n  name: product-productName\n  namespace: argocd\nspec:\n  description: Project for product-productName\n  sourceRepos:\n    - "*"\n  destinations:\n    - namespace: product-productName\n      server: https://kubernetes.default.svc\n  # Allow all namespaced-scoped resources to be created, except for ResourceQuota, LimitRange, NetworkPolicy\n  namespaceResourceBlacklist:\n    - group: ""\n      kind: ResourceQuota\n    - group: ""\n      kind: LimitRange\n    - group: ""\n      kind: NetworkPolicy\n  roles:\n    - name: team-admin\n      description: All access to applications inside project-bpdm. Read only on project itself\n      policies:\n        - p, proj:product-productName:team-admin, applications, *, product-productName/*, allow\n      groups:\n        - catenax-ng:product-productName\n')),(0,o.kt)("p",null,"Store this manifest in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/catenax-ng/k8s-cluster-stack"},"k8s-cluster-stack")," repo in\npath ",(0,o.kt)("inlineCode",{parentName:"p"},"environments/hotel-budapest/argo-projects/"),"."),(0,o.kt)("h3",{id:"create-avp-secret"},"Create AVP Secret"),(0,o.kt)("p",null,"To enable the product-team to use Vault with ArgoCD create a team specific AVP secret manifest:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Secret\nmetadata:\n  annotations:\n    avp.kubernetes.io/path: "devsecops/data/avp-config/product-productName"\n  name: vault-secret\n  namespace: product-productName\ntype: Opaque\nstringData:\n  VAULT_ADDR: https://vault.demo.catena-x.net/\n  AVP_TYPE: vault\n  AVP_AUTH_TYPE: approle\n  AVP_ROLE_ID: <role_id>\n  AVP_SECRET_ID: <secret_id>\n')),(0,o.kt)("p",null,"Store this manifest in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/catenax-ng/k8s-cluster-stack"},"k8s-cluster-stack")," repo in\npath ",(0,o.kt)("inlineCode",{parentName:"p"},"environments/hotel-budapest/avp-secrets/"),"."),(0,o.kt)("p",null,"The secret will be called ",(0,o.kt)("em",{parentName:"p"},"vault-secret")," and stored in k8s namespace related to product-team."),(0,o.kt)("h3",{id:"prepare-deployment-of-argocd-project-and-avp-secret"},"Prepare Deployment Of ArgoCD Project And AVP Secret"),(0,o.kt)("p",null,"To deploy k8s namespace, ArgoCD Project and the AVP secret to Hotel Budapest you'll have to add the two created manifest\nfiles to ",(0,o.kt)("inlineCode",{parentName:"p"},"environments/hotel-budapest/kustomization.yaml"),"\nin ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/catenax-ng/k8s-cluster-stack"},"k8s-cluster-stack")," repo:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization\n\n#namespace: argocd\n\nresources:\n  [ ... ]\n  - argo-projects/product-productName.yaml\n  - avp-secrets/productName-vault-secret.yaml\n  [ ... ]\n")),(0,o.kt)("p",null,"Please add the new product-team in alphabetical order to the ",(0,o.kt)("em",{parentName:"p"},"resources")," section of file ",(0,o.kt)("inlineCode",{parentName:"p"},"kustomization.yaml"),"."),(0,o.kt)("h3",{id:"create-pull-request"},"Create Pull Request"),(0,o.kt)("p",null,"After you have created the three files"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"environments/hotel-budapest/argo-projects/product-productName.yaml")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"environments/hotel-budapest/avp-config/productName-team-vault-secret.yaml")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"environments/hotel-budapest/kustomization.yaml"))),(0,o.kt)("p",null,"create a PR for your branch. After the PR has been approved and merged into main branch, the new team will be\nautomatically deployed to Hotel Budapest cluster (via ArgoCD application ",(0,o.kt)("em",{parentName:"p"},"hotel-budapest-config")," at ArgoCD ",(0,o.kt)("em",{parentName:"p"},"CORE"),"\ncluster)."),(0,o.kt)("h2",{id:"special-topics"},"Special Topics"),(0,o.kt)("h3",{id:"enable-access-to-a-private-repository-via-deploy-key"},"Enable access to a private repository via deploy key"),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"The project/product has to follow the steps which can be found\nhere: ",(0,o.kt)("a",{parentName:"p",href:"guides/how-to-prepare-a-private-repo"},"How to prepare a private repo"),"."))),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Go to ",(0,o.kt)("inlineCode",{parentName:"p"},"catenax-ng\\k8s-cluster-stack\\environments\\hotel-budapest\\argo-repos"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Add a file named ",(0,o.kt)("inlineCode",{parentName:"p"},"<productName>-repo.yaml"),", e.g. for ",(0,o.kt)("em",{parentName:"p"},"product-semantics")," (",(0,o.kt)("inlineCode",{parentName:"p"},"product-semantics-repo.yaml"),"):"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Secret\nmetadata:\n  name: product-semantics-repo\n  namespace: argocd\n  annotations:\n    avp.kubernetes.io/path: "semantics/data/deploy-key"\n  labels:\n    argocd.argoproj.io/secret-type: repository\nstringData:\n  type: git\n  url: git@github.com:catenax-ng/product-semantics\n  name: product-semantics-repo\n  project: project-semantics\n  sshPrivateKey: |\n    <semantics-deploy-key>\n'))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Add following line to ",(0,o.kt)("inlineCode",{parentName:"p"},"environments/hotel-budapest/kustomization.yaml")),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"- argo-repos/product-semantics-repo.yaml\n")))),(0,o.kt)("h3",{id:"enable-access-to-a-private-package-central-pull-secret"},"Enable access to a private package (central pull secret)"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Create a PAT within GitHub user account (machine user)\nsettings - Developer settings - Personal access token. Be sure to give just the needed rights (read:package will be\nsufficient to deploy)")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},'Now do a base64 encoding for the PAT $ echo -n "<username',">",":<PAT",">",'" | base64')),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Create a file ",(0,o.kt)("inlineCode",{parentName:"p"},".dockerconfigjson")," containing the base-64 encoded PAT"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "auths": {\n    "ghcr.io": {\n      "auth": "<base-64 encoded PAT>"\n    }\n  }\n}\n'))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Do a base 64 encoding for the auth part"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'echo -n\'{"auths":{"ghcr.io":{"auth":"<base-64 encoded PAT>"}}}\' | base64\n')),(0,o.kt)("p",{parentName:"li"},"If the output is divided into 2 lines, just add the second line to the first (without space)")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Create a file ",(0,o.kt)("inlineCode",{parentName:"p"},"dockerconfigjson.yaml"),":"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"kind: Secret\ntype: kubernetes.io/dockerconfigjson\napiVersion: v1\nmetadata:\n  name: budapest-machine-user-read-package\n  labels:\n    app: app-name\ndata:\n  .dockerconfigjson: <base64 encoded auth part, output from second base64 encoding>\n"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Then add the secret to the cluster"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl create -f dockerconfigjson.yaml\n"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Pull secret has to be added to the product\xb4s code"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"imagePullSecrets:\n  - name: <name of the pull secret>\n")))))}u.isMDXComponent=!0},6584:function(e,t,a){t.Z=a.p+"assets/images/gh-add-team-member-role-28233c9cf9e261efb285ad2910e63e24.png"}}]);